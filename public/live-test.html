<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Live Site Test - Coin AI Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        .test-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4299e1;
        }
        button {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            background: #f0fff4;
            border-color: #38a169;
            color: #2d3748;
        }
        .error {
            background: #fed7d7;
            border-color: #e53e3e;
            color: #2d3748;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4299e1;
        }
        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }
        .test-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-link {
            background: #4299e1;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .test-link:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }
        .step {
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .step:last-child {
            border-bottom: none;
        }
        .step-status {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            margin-right: 10px;
            font-weight: bold;
        }
        .step-pending {
            background: #e2e8f0;
            color: #718096;
        }
        .step-running {
            background: #4299e1;
            color: white;
        }
        .step-success {
            background: #38a169;
            color: white;
        }
        .step-error {
            background: #e53e3e;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Live Site End-to-End Test</h1>
        <p style="color: #718096; font-size: 18px; margin-bottom: 30px;">
            Πραγματικό test του coin-ai-market.vercel.app για να επιβεβαιώσουμε ότι όλες οι λειτουργίες δουλεύουν
        </p>

        <div class="test-section">
            <h2>🎯 Test Objectives</h2>
            <div id="test-steps">
                <div class="step">
                    <span class="step-status step-pending" id="step1">1</span>
                    <strong>Δημιουργία Test Coin</strong> - Δημιουργεί νέο νόμισμα στο Supabase
                </div>
                <div class="step">
                    <span class="step-status step-pending" id="step2">2</span>
                    <strong>Store Connection</strong> - Επιβεβαιώνει ότι το νόμισμα συνδέεται με το store
                </div>
                <div class="step">
                    <span class="step-status step-pending" id="step3">3</span>
                    <strong>Database Queries</strong> - Ελέγχει αν εμφανίζεται σε όλα τα queries
                </div>
                <div class="step">
                    <span class="step-status step-pending" id="step4">4</span>
                    <strong>Live Verification</strong> - Επιβεβαιώνει ότι εμφανίζεται στο live site
                </div>
            </div>
        </div>

        <div class="test-section">
            <button onclick="runFullTest()" id="testBtn">
                🚀 Εκτέλεση Πλήρους Test
            </button>
            <button onclick="clearResults()" id="clearBtn">
                🧹 Καθαρισμός Αποτελεσμάτων
            </button>
        </div>

        <div id="results"></div>
        
        <div id="testLinks" style="display: none;">
            <div class="test-section">
                <h3>🔗 Test Navigation Links</h3>
                <div class="test-links">
                    <a href="https://coin-ai-market.vercel.app/" target="_blank" class="test-link">
                        🏠 Homepage (Featured Coins)
                    </a>
                    <a href="https://coin-ai-market.vercel.app/marketplace" target="_blank" class="test-link">
                        🛒 Marketplace
                    </a>
                    <a href="https://coin-ai-market.vercel.app/category/greek" target="_blank" class="test-link">
                        🇬🇷 Greek Category
                    </a>
                    <a href="#" id="storeLink" target="_blank" class="test-link">
                        🏪 Store Page
                    </a>
                    <a href="#" id="coinLink" target="_blank" class="test-link">
                        🪙 Coin Page
                    </a>
                    <a href="https://coin-ai-market.vercel.app/admin" target="_blank" class="test-link">
                        ⚙️ Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://qsgbyfwjivllpjzwrqvo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZ2J5ZndqaXZsbHBqendycXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzMTE3OTYsImV4cCI6MjA1MDg4Nzc5Nn0.sjmL9M9-WG5bvpHLMJD7NaatU-2TQ6H5_EWzb6lhpE0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let testData = {};

        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step-status step-${status}`;
            if (status === 'running') {
                step.innerHTML = '<div class="loading"></div>';
            } else if (status === 'success') {
                step.innerHTML = '✓';
            } else if (status === 'error') {
                step.innerHTML = '✗';
            }
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('testLinks').style.display = 'none';
            // Reset steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.className = 'step-status step-pending';
                step.innerHTML = i;
            }
        }

        async function runFullTest() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"></div> Εκτέλεση Test...';
            
            clearResults();
            
            try {
                // Step 1: Create test coin
                updateStep(1, 'running');
                addResult('🧪 <strong>Βήμα 1:</strong> Δημιουργία test coin...', 'info');
                
                const coinResult = await createTestCoin();
                testData = coinResult;
                
                updateStep(1, 'success');
                addResult(`✅ <strong>Test coin δημιουργήθηκε:</strong><br>
                    • Όνομα: ${coinResult.coin.name}<br>
                    • ID: ${coinResult.coin.id}<br>
                    • Store: ${coinResult.store.name}`, 'success');

                // Step 2: Verify store connection
                updateStep(2, 'running');
                addResult('🔗 <strong>Βήμα 2:</strong> Επιβεβαίωση store connection...', 'info');
                
                const storeVerification = await verifyStoreConnection(coinResult);
                updateStep(2, 'success');
                addResult(`✅ <strong>Store connection verified:</strong><br>
                    • Store ID: ${coinResult.store.id}<br>
                    • Store Active: ${coinResult.store.is_active}<br>
                    • Coin-Store Link: Verified`, 'success');

                // Step 3: Database queries
                updateStep(3, 'running');
                addResult('🔍 <strong>Βήμα 3:</strong> Έλεγχος database queries...', 'info');
                
                const queryResults = await verifyDatabaseQueries(coinResult);
                updateStep(3, 'success');
                
                // Display stats
                const statsHtml = `
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${queryResults.totalStoreCoins}</div>
                            <div class="stat-label">Store Coins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${queryResults.totalUserCoins}</div>
                            <div class="stat-label">User Coins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${queryResults.totalFeaturedCoins}</div>
                            <div class="stat-label">Featured Coins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${queryResults.totalCategoryCoins}</div>
                            <div class="stat-label">Greek Category</div>
                        </div>
                    </div>
                `;
                addResult(`✅ <strong>Database Queries Results:</strong>${statsHtml}
                    • Appears in Store Query: ${queryResults.appearsInStore ? '✅' : '❌'}<br>
                    • Appears in User Query: ${queryResults.appearsInUser ? '✅' : '❌'}<br>
                    • Appears in Featured Query: ${queryResults.appearsInFeatured ? '✅' : '❌'}<br>
                    • Appears in Category Query: ${queryResults.appearsInCategory ? '✅' : '❌'}`, 'success');

                // Step 4: Live verification
                updateStep(4, 'running');
                addResult('🌐 <strong>Βήμα 4:</strong> Live site verification...', 'info');
                
                // Set up test links
                document.getElementById('storeLink').href = `https://coin-ai-market.vercel.app/store/${coinResult.store.id}`;
                document.getElementById('coinLink').href = `https://coin-ai-market.vercel.app/coin/${coinResult.coin.id}`;
                document.getElementById('testLinks').style.display = 'block';
                
                updateStep(4, 'success');
                addResult(`🎉 <strong>TEST ΟΛΟΚΛΗΡΏΘΗΚΕ ΕΠΙΤΥΧΏΣ!</strong><br><br>
                    <strong>Το νόμισμα θα πρέπει να εμφανίζεται τώρα σε:</strong><br>
                    • 🏠 Homepage (αν είναι featured)<br>
                    • 🏪 Store page του dealer<br>
                    • 🇬🇷 Greek category page<br>
                    • 🛒 Marketplace<br>
                    • 🪙 Ξεχωριστή σελίδα προϊόντος<br><br>
                    <strong>Χρησιμοποιήστε τα links παραπάνω για να επιβεβαιώσετε!</strong>`, 'success');

            } catch (error) {
                console.error('Test failed:', error);
                addResult(`❌ <strong>TEST FAILED:</strong> ${error.message}`, 'error');
                // Mark current step as error
                for (let i = 1; i <= 4; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (step.className.includes('running')) {
                        updateStep(i, 'error');
                        break;
                    }
                }
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '🚀 Εκτέλεση Πλήρους Test';
            }
        }

        async function createTestCoin() {
            // First check/create store
            const { data: stores, error: storeError } = await supabase
                .from('stores')
                .select('*')
                .eq('user_id', '47fc544e-c907-4112-949a-4399d7703217');

            if (storeError) {
                throw new Error(`Store fetch error: ${storeError.message}`);
            }

            let targetStore = stores?.find(s => s.name === 'GREECE COIN - ERROR COIN');
            
            if (!targetStore) {
                const { data: newStore, error: createError } = await supabase
                    .from('stores')
                    .insert({
                        name: 'GREECE COIN - ERROR COIN',
                        description: 'Explore the Rich Legacy of Greek Coinage & Rare Mint Errors. Test store for verification.',
                        user_id: '47fc544e-c907-4112-949a-4399d7703217',
                        verified: true,
                        is_active: true
                    })
                    .select()
                    .single();
                
                if (createError) {
                    throw new Error(`Store creation error: ${createError.message}`);
                }
                
                targetStore = newStore;
            }

            // Create test coin
            const timestamp = new Date().toISOString().substr(0,19).replace('T', ' ');
            const { data: coin, error: coinError } = await supabase
                .from('coins')
                .insert({
                    name: `🧪 LIVE TEST Greek Coin ${timestamp}`,
                    year: 1978,
                    country: 'Greece',
                    denomination: '10 Lepta',
                    price: 29.00,
                    description: `LIVE VERIFICATION TEST - Greek coin created at ${timestamp} to verify end-to-end functionality`,
                    category: 'greek',
                    rarity: 'Common',
                    grade: 'VF',
                    condition: 'Very Fine',
                    is_auction: false,
                    featured: true,
                    user_id: '47fc544e-c907-4112-949a-4399d7703217',
                    store_id: targetStore.id,
                    image: 'https://images.unsplash.com/photo-1605792657660-596af9009e82?w=400&h=400&fit=crop',
                    authentication_status: 'ai_verified',
                    ai_confidence: 0.95,
                    views: 0,
                    favorites: 0,
                    sold: false
                })
                .select()
                .single();

            if (coinError) {
                throw new Error(`Coin creation error: ${coinError.message}`);
            }

            return { coin, store: targetStore };
        }

        async function verifyStoreConnection(coinResult) {
            const { data: storeCheck } = await supabase
                .from('stores')
                .select('*')
                .eq('id', coinResult.store.id)
                .single();
            
            const { data: coinCheck } = await supabase
                .from('coins')
                .select('*')
                .eq('id', coinResult.coin.id)
                .single();
            
            if (!storeCheck || !coinCheck || coinCheck.store_id !== storeCheck.id) {
                throw new Error('Store-Coin connection verification failed');
            }
            
            return true;
        }

        async function verifyDatabaseQueries(coinResult) {
            // Query by store
            const { data: storeCoins } = await supabase
                .from('coins')
                .select('*')
                .eq('store_id', coinResult.store.id);
            
            // Query by user
            const { data: userCoins } = await supabase
                .from('coins')
                .select('*')
                .eq('user_id', coinResult.coin.user_id);
            
            // Query featured
            const { data: featuredCoins } = await supabase
                .from('coins')
                .select('*')
                .eq('featured', true);
            
            // Query category
            const { data: categoryCoins } = await supabase
                .from('coins')
                .select('*')
                .eq('category', 'greek');
            
            return {
                appearsInStore: storeCoins?.some(c => c.id === coinResult.coin.id) || false,
                appearsInUser: userCoins?.some(c => c.id === coinResult.coin.id) || false,
                appearsInFeatured: featuredCoins?.some(c => c.id === coinResult.coin.id) || false,
                appearsInCategory: categoryCoins?.some(c => c.id === coinResult.coin.id) || false,
                totalStoreCoins: storeCoins?.length || 0,
                totalUserCoins: userCoins?.length || 0,
                totalFeaturedCoins: featuredCoins?.length || 0,
                totalCategoryCoins: categoryCoins?.length || 0
            };
        }
    </script>
</body>
</html> 